<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Komu W - How to store application logs in timescaleDB/postgres.</title>
    <meta name="description" content="How to store application logs in timescaleDB/postgres." />
    <meta property="og:url" content="https://www.komu.engineer/blog" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ADD FAVICON -->

    <link rel="stylesheet" href="../../site.css">

    <!-- Get highlightjs by going to https://highlightjs.org/download/, select the languages you want and download. -->
    <link rel="stylesheet" href="../../highlightjs/styles/default.css">
    <script src="../../highlightjs/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="https://www.komu.engineer">Home</a>&nbsp;&nbsp;
            <a href="https://www.komu.engineer/about">About Me</a>&nbsp;&nbsp;
            <a href="https://www.komu.engineer/blog">Blog</a>&nbsp;&nbsp;
        </div>
        <div class="left-sidebar">
            .
        </div>
        <div class="right-sidebar">
            .
        </div>

        <div class="main">
            <p>
                <strong>How to store application logs in timescaleDB/postgres.(06 December 2018)</strong>
                </br>
                </br>

                <strong>Intro</strong>
                </br>
                If the title alone has already turned you off, I understand. It's almost unheard of to store
                application logs in a structured datastore.</br>
                Whenever people talk about logs and their logging pipeline, it usually involves <a target="_blank" rel="noopener"
                    href="https://www.elastic.co/elk-stack">ELK(Elasticsearch)</a>, MongoDB or such other NoSQL
                databases.</br></br>

                And no such talk is complete without a tale of how people have to stay up at night feeding their
                Elasticsearch monstrous JVM with the blood of unblemished year-old sheep(or whatever JVM's feed on).</br></br>

                And it does make a lot of sense to store logs in an unstructured database, because after all, logs are
                unstructured by nature. Are they?


                </br></br>
                <strong>Opinion</strong>
                </br>
                I hold a differing opinion, I think if you look at logs hard enough; a structure starts to emerge.</br>
                In this section, I'll lay out my opinion about logs and logging in general.</br>
                This are my opinions and I hold no brief for anybody. I'm not going to try and convince you to adopt my
                worldview, but atleast to consider it.</br></br>

                <i>opinion 1:</i> logs are actually structured.</br>
                If you look at an <a target="_blank" rel="noopener" href="https://cdn.haproxy.com/wp-content/uploads/2017/07/aloha_load_balancer_memo_log.pdf">example
                    HTTP log</a> for the popular haproxy tcp/http load balancer:

                <pre><code class="bash">
Mar 9 15:08:05 LB1 local0.info haproxy[21843]: 10.0.0.1:1028 [09/Mar/2012:15:08:05.179] FT BK/SRV 0/0/1/8/9 304 12 - - ”GET / HTTP/1.1”
                </code></pre>
                You can see a lot of structure in it, there's; <i>timestamp</i>, <i>client IP address</i>, <i>backend
                    name</i>, <i>response time</i>, <i>status code</i> etc</br>
                And all this things will be available in every log event, that's a lot of structure.</br></br>


                <i>opinion 2:</i> You should annotate your logs with more structured information to make them
                much more useful</br>
                Take the haproxy log above, it would be much more useful if we added things like;
                <ul>
                    <li>the environment the application is running in(production/test/dev/staging etc)</li>
                    <li>the IP address of the server that the app is running in</li>
                    <li>the name of the service</li>
                    <li>etc</li>
                </ul>

                <i>opinion 3:</i> logs should be primarily used to help debug issues in production.</br></br>

                <i>opinion 4:</i> logs should only be persisted for a short period of time(~7days).</br>
                This is a corollary of opinion 3 above. If we buy the argument that logs are for debugging purposes,
                then we can also argue that if an issue occurs in production, you ought to debug it asap. Which means,
                you only need to store logs
                for a max of 7days.</br>
                What you do with the logs after 7days(7 is just a rough estimate) is upto you; you can send them to
                /dev/null, or AWS s3 or some
                other cold storage but they should not be lying around in your
                primary log store.</br></br>

                <i>opinion 5:</i> you should not lose logs, but it should not be a big deal if you do.</br></br>

                <i>opinion 6:</i> logs can be time-series data.</br>
                breathe deeply. time-series data at this point in time in our industry is a loaded term that means
                different things to different people.</br>
                The definition of what time-series data is that I like asscociating myself with is;
                <strong>data that collectively represents how a system/process/behavior changes over time. </strong> -
                <a target="_blank" rel="noopener" href="https://blog.timescale.com/what-the-heck-is-time-series-data-and-why-do-i-need-a-time-series-database-dcf3b1b18563">taken
                    from the blogpost; What the heck is time-series data </a></br>
                ie, the following log events are time-series data:

                <pre><code class="bash">

time                          | application_name | environment_name |     log_event      | trace_id |            file_path        |  host_ip   |      data
------------------------------+------------------+------------------+--------------------+----------+-----------------------------+------------+------------------------------------------------------------------------
2018-11-18 14:07:18.936522+00 | ETL_app          | production       | video_process_job3 | caf72697 | /usr/src/app/code/etl.py    | 172.23.0.2 | {"job_id": "658d31dd85fd", "jobType": "batch"}
2018-11-18 14:14:58.223893+00 | ETL_app          | canary           | video_process_job3 | 17603a0  | /usr/src/app/code/etl.py    | 172.23.0.3 | {"error": "Traceback (most recent call last):\n  File \"/usr/src/app/code/etl.py\", line 129, in job3\n    ourJobs[5]\nIndexError: list index out of range\n", "job_id": "c1a164c2-86c5-43e6-a0e5-3ca2377abe95", "jobType": "batch"}
2018-11-18 14:09:09.581655+00 | WebApp           | production       | login              | 45a7dc73 | /usr/src/app/code/web.py    | 172.23.0.2 | {"user": "Shawn Corey Carter", "email": "someemail@email.com", "status_code": 504, "response_time": 95}
2018-11-18 14:09:09.580918+00 | WebApp           | production       | login              | 0f776af0 | /usr/src/app/code/web.py    | 172.23.0.2 | {"user": "Shawn Corey Carter", "email": "someemail@email.com", "status_code": 504, "response_time": 6}
2018-11-18 14:09:10.552307+00 | WorkerApp        | staging          | process_work       | 6d07fb95 | /usr/src/app/code/worker.py | 172.23.0.2 | {"worker_id": "97b44537", "datacenter": "us-west"}
2018-11-18 14:09:10.551532+00 | WorkerApp        | production       | process_work       | 8b2daa49 | /usr/src/app/code/woker.py  | 172.23.0.2 | {"worker_id": "a6035461, "datacenter": "us-west"}
                </code></pre>
                you can(and probably should) fashion your logs as time-series events.
                </br></br>

                When we consider all that, we see that an SQL database is not that bad of an idea as a medium for
                storing logs.</br>
                And on top of that you gain a lot of other added advantages:
                <ul>
                    <li>you query using SQL which is relatively easy to learn</li>
                    <li>your fellow developers probably already know SQL</li>
                    <li>you do not have to learn a new query language from splunk/sumologic/elasctic/influxdb et al
                    </li>
                    <li>access to all the domain knowledge in your SQL database ecosystem(stackoverflow/google etc)</li>
                    <li>access to all the tools/extensions in your SQL database ecosystem</li>
                    <li>your average SQL database is relatively easy to operate</li>
                </ul>

                </br></br>
                <strong>timescaleDB/postgres</strong>
                </br>
                PostgreSQL is a popular SQL datatabse whereas TimescaleDB, despite the name, is actually an open-source
                postgres extension that enhances postgres for time-series data.</br>
                TimescaleDB <a target="_blank" rel="noopener" href="https://blog.timescale.com/timescaledb-vs-6a696248104e">optimizes
                    postgres for working with time-series data.</a></br>
                In this blogpost, we are going to use timescaleDB extension for storing logs.






            </p>

        </div>
    </div>
</body>